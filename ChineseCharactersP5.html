<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小学五年级，1-4课选词填空</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <!-- Add Inter font for Pinyin -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <!-- PWA: Removed link to manifest.json as it requires web hosting -->
    <!-- PWA: Removed Apple Touch Icon for iOS devices as it requires web hosting -->
    <!-- PWA: Removed theme color for browser UI as it requires web hosting -->

    <!-- Chosen Palette: Calm Harmony (主色调为柔和的灰白，搭配清新的蓝色和绿色作为强调色) -->
    <!-- Application Structure Plan: 这是一个单页的词汇问答游戏。结构分为：游戏介绍、游戏区域（显示词汇、汉字书写区、选项按钮）、得分区和游戏结束/重置区。选择此结构是为了提供一个清晰、直观的游戏流程，让用户专注于词汇学习，避免不必要的导航。 -->
    <!-- Visualization & Content Choices: 
        - 报告信息: 词汇列表 -> 目标: 学习/测试 -> 呈现方式: 问答形式，显示汉字、拼音和英文选项 -> 交互: 点击选项进行选择 -> 理由: 问答形式直接测试掌握程度。
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f8f9fa; /* Light background */
            color: #343a40; /* Dark text */
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* Rounded corners */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 2rem;
        }
        .btn-primary {
            background-color: #007bff; /* Blue */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-option {
            background-color: #e9ecef; /* Light gray */
            color: #343a40;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, transform 0.1s;
            width: 100%;
            text-align: left;
            font-size: 1.125rem; /* Increased font size for options (text-lg) */
            line-height: 1.75rem; /* Default line-height for text-lg */
        }
        .btn-option:hover {
            background-color: #dee2e6;
            transform: translateY(-2px);
        }
        .btn-option.correct {
            background-color: #28a745; /* Green for correct */
            color: white;
        }
        .btn-option.incorrect {
            background-color: #dc3545; /* Red for incorrect */
            color: white;
        }
        /* Removed hanzi-writer-container specific CSS as it's no longer used for a separate card */
        #pinyin-word {
            font-family: 'Inter', sans-serif; /* Apply Inter font for Pinyin */
            font-weight: 600; /* Keep semibold weight */
            font-size: 1.875rem; /* text-3xl */
            line-height: 2.25rem; /* md:text-4xl */
        }
        @media (min-width: 768px) {
            #pinyin-word {
                font-size: 2.25rem; /* md:text-4xl */
                line-height: 2.5rem;
            }
        }
        /* Adjusted logo and header styling for left alignment and larger logo */
        .header-section {
            display: flex;
            align-items: center; /* Vertically align items */
            margin-bottom: 1.5rem;
            padding-left: 1rem; /* Add some left padding to move it from the very edge */
            padding-top: 1rem; /* Add some top padding */
        }
        .logo {
            max-width: 300px; /* Increased size */
            height: auto;
            border-radius: 0.5rem; /* Slightly rounded corners for the image */
            margin-right: 1rem; /* Space between logo and title */
        }
        @media (max-width: 768px) {
            .logo {
                max-width: 180px; /* Adjust for smaller screens */
            }
            .header-section {
                padding-left: 0.5rem;
                padding-top: 0.5rem;
            }
        }
        /* Removed .hanzi-writer-container and #character-target-div styles */
        /* Removed .audio-loading-indicator styles */
    </style>
</head>
<body class="min-h-screen flex items-center justify-center py-10">

    <div class="container bg-white card">
        <div class="header-section">
            <img src="https://awat.ac.th/images/header-132-1/logo.png" alt="Anuban WatAngthong School Logo" class="logo">
            <h1 class="text-2xl md:text-3xl font-bold text-blue-600">小学五年级，1-4课选词填空</h1>
        </div>
        <p class="text-center text-gray-600 text-lg mb-8">มาทดสอบคำศัพท์ภาษาจีนชั้นประถมศึกษาปีที่ 5 บทที่ 1-4 ของคุณกัน! </p>

        <div id="game-area" class="space-y-6">
            <div class="text-center mb-6">
                <p class="text-xl text-gray-700">คำศัพท์ปัจจุบัน:</p>
                <!-- Display the English/Thai meaning for fill-in-the-blank -->
                <h2 id="english-meaning" class="text-4xl md:text-5xl font-bold text-gray-800 mb-2"></h2> 
                <p id="pinyin-word" class="text-2xl md:text-3xl text-blue-500 font-semibold mb-4"></p>
                <!-- Removed audio button and HanziWriter container -->
            </div>

            <!-- Options container for multiple choice -->
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Options will be rendered here by JavaScript -->
            </div>

            <div id="feedback-message" class="text-center text-xl font-bold mt-6 hidden"></div>
            <div class="flex justify-center mt-8">
                <button id="next-word-btn" class="btn-primary hidden">คำถามถัดไป</button>
            </div>
        </div>

        <div id="game-over-area" class="text-center hidden">
            <h2 class="text-3xl font-bold mb-4 text-blue-600">จบเกมแล้ว!</h2>
            <p class="text-xl text-gray-700 mb-4">คุณตอบถูก <span id="final-score" class="font-bold text-green-600">0</span> ข้อ จากทั้งหมด <span id="total-questions" class="font-bold text-gray-800">0</span> ข้อ</p>
            <button id="restart-game-btn" class="btn-primary">เริ่มใหม่</button>
        </div>

        <div class="text-center mt-8 text-gray-500 text-sm">
            <p>คะแนนปัจจุบัน: <span id="score">0</span> / <span id="total-count">0</span></p>
        </div>

        <hr class="my-8 border-gray-300">

        <div id="upload-vocabulary-section" class="mt-8 p-6 bg-gray-50 rounded-lg shadow-inner">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">อัปเดตคำศัพท์</h2>
            <p class="text-gray-600 mb-4 text-center">คุณสามารถอัปโหลดไฟล์ JSON เพื่ออัปデートชุดคำศัพท์ในเกมได้</p>
            <div class="flex flex-col items-center space-y-4">
                <input type="file" id="vocabulary-file-input" accept=".json" class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100 cursor-pointer">
                <button id="upload-vocabulary-btn" class="btn-primary w-fit">อัปโหลดและเริ่มเกมใหม่</button>
                <div id="upload-feedback-message" class="text-sm mt-2 hidden"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let vocabulary = [ // Initial vocabulary
              {"chinese": "起床", "pinyin": "Qǐ chuáng", "english": "ตื่นนอน"},
              {"chinese": "刷牙", "pinyin": "Shuā yá", "english": "แปรงฟัน"},
              {"chinese": "洗脸", "pinyin": "Xǐ liǎn", "english": "ล้างหน้า"},
              {"chinese": "上学", "pinyin": "Shàng xué", "english": "ไปโรงเรียน"},
              {"chinese": "放学", "pinyin": "Fàng xué", "english": "เลิกเรียน"},
              {"chinese": "洗澡", "pinyin": "Xǐ zǎo", "english": "อาบน้ำ"},
              {"chinese": "睡觉", "pinyin": "Shuì jiào", "english": "นอน"},
              {"chinese": "熊", "pinyin": "Xióng", "english": "หมี"},
              {"chinese": "急忙", "pinyin": "Jí máng", "english": "รีบ"},
              {"chinese": "穿", "pinyin": "Chuān", "english": "สวม / ใส่"},
              {"chinese": "博物馆", "pinyin": "Bó wù guǎn", "english": "พิพิธภัณฑ์"},
              {"chinese": "功课", "pinyin": "Gōng kè", "english": "การบ้าน"},
              {"chinese": "中国菜", "pinyin": "Zhōng guó cài", "english": "อาหารจีน"},
              {"chinese": "派对", "pinyin": "Pài duì", "english": "ปาร์ตี้"},
              {"chinese": "商场", "pinyin": "Shāng chǎng", "english": "ห้างสรรพสินค้า"},
              {"chinese": "海边", "pinyin": "Hǎi biān", "english": "ชายทะเล"},
              {"chinese": "餐馆", "pinyin": "Cān guǎn", "english": "ร้านอาหาร"},
              {"chinese": "参观", "pinyin": "Cān guān", "english": "เยี่ยมชม"},
              {"chinese": "来", "pinyin": "Lái", "english": "มา"},
              {"chinese": "全家", "pinyin": "Quán jiā", "english": "ทั้งครอบครัว"},
              {"chinese": "参加", "pinyin": "Cān jiā", "english": "เข้าร่วม"},
              {"chinese": "常常", "pinyin": "Cháng cháng", "english": "บ่อยๆ"},
              {"chinese": "一起", "pinyin": "Yī qǐ", "english": "ด้วยกัน"},
              {"chinese": "青草", "pinyin": "Qīng cǎo", "english": "หญ้าสีเขียว"},
              {"chinese": "要", "pinyin": "Yào", "english": "ต้องการ"},
              {"chinese": "上面", "pinyin": "Shàng miàn", "english": "ข้างบน"},
              {"chinese": "下面", "pinyin": "Xià miàn", "english": "ข้างล่าง"},
              {"chinese": "前面", "pinyin": "Qián miàn", "english": "ข้างหน้า"},
              {"chinese": "后面", "pinyin": "Hòu miàn", "english": "ข้างหลัง"},
              {"chinese": "左边", "pinyin": "Zuǒ biān", "english": "ข้างซ้าย"},
              {"chinese": "右边", "pinyin": "Yòu biān", "english": "ข้างขวา"},
              {"chinese": "家乡", "pinyin": "Jiā xiāng", "english": "บ้านเกิด"},
              {"chinese": "美丽", "pinyin": "Měi lì", "english": "สวยงาม"},
              {"chinese": "小山村", "pinyin": "Xiǎo shān cūn", "english": "หมู่บ้านเล็กๆ บนภูเขา"},
              {"chinese": "佛寺", "pinyin": "Fó sì", "english": "วัด"},
              {"chinese": "鸭群", "pinyin": "Yā qún", "english": "ฝูงเป็ด"},
              {"chinese": "草地", "pinyin": "Cǎo dì", "english": "ทุ่งหญ้า"},
              {"chinese": "五颜六色", "pinyin": "Wǔ yán liù sè", "english": "หลากสี"},
              {"chinese": "图画", "pinyin": "Tú huà", "english": "รูปภาพ"},
              {"chinese": "游泳衣", "pinyin": "Yóu yǒng yī", "english": "ชุดว่ายน้ำ"},
              {"chinese": "游泳", "pinyin": "Yóu yǒng", "english": "ว่ายน้ำ"},
              {"chinese": "太阳帽", "pinyin": "Tài yáng mào", "english": "หมวกกันแดด"},
              {"chinese": "晒太阳", "pinyin": "Shài tài yáng", "english": "อาบแดด"},
              {"chinese": "捡贝壳", "pinyin": "Jiǎn bèi ké", "english": "เก็บเปลือกหอย"},
              {"chinese": "钓鱼", "pinyin": "Diào yú", "english": "ตกปลา"},
              {"chinese": "蝴蝶", "pinyin": "Hú dié", "english": "ผีเสื้อ"},
              {"chinese": "芭堤雅", "pinyin": "Bā dì yá", "english": "พัทยา"},
              {"chinese": "太好了", "pinyin": "Tài hǎo le", "english": "ดีมาก"},
              {"chinese": "带", "pinyin": "Dài", "english": "พา / เอาไป"},
              {"chinese": "戴", "pinyin": "Dài", "english": "สวม / ใส่"},
              {"chinese": "高高兴兴", "pinyin": "Gāogāoxìngxìng", "english": "อย่างมีความสุข"},
              {"chinese": "一会儿", "pinyin": "Yīhuìr", "english": "สักครู่"},
              {"chinese": "飞", "pinyin": "Fēi", "english": "บิน"},
              {"chinese": "捉", "pinyin": "Zhuō", "english": "จับ"},
              {"chinese": "没", "pinyin": "Méi", "english": "ไม่มี"},
              {"chinese": "到", "pinyin": "Dào", "english": "ถึง"},
              {"chinese": "专心", "pinyin": "Zhuānxīn", "english": "ตั้งใจ"}
            ];

            let currentWordIndex = 0;
            let score = 0;
            let totalQuestionsAnswered = 0;
            let shuffledVocabulary = [];
            // Removed hanziWriter instance as it's no longer used

            const englishMeaningEl = document.getElementById('english-meaning'); 
            const pinyinWordEl = document.getElementById('pinyin-word');
            const optionsContainer = document.getElementById('options-container');
            const feedbackMessageEl = document.getElementById('feedback-message');
            const nextWordBtn = document.getElementById('next-word-btn');
            const scoreEl = document.getElementById('score');
            const totalCountEl = document.getElementById('total-count');
            const gameArea = document.getElementById('game-area');
            const gameOverArea = document.getElementById('game-over-area');
            const finalScoreEl = document.getElementById('final-score');
            const totalQuestionsEl = document.getElementById('total-questions');
            const restartGameBtn = document.getElementById('restart-game-btn');
            // Removed characterTargetDiv, playAudioBtn, audioLoadingIndicator as they are no longer used
            
            const vocabularyFileInput = document.getElementById('vocabulary-file-input');
            const uploadVocabularyBtn = document.getElementById('upload-vocabulary-btn');
            const uploadFeedbackMessageEl = document.getElementById('upload-feedback-message');

            // --- Web Audio API for feedback sounds ---
            let audioCtx;

            function initAudioContext() {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
            }

            function playCorrectSound() {
                initAudioContext();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.type = 'sine';
                oscillator.frequency.value = 880; // A5 note
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.3);
            }

            function playIncorrectSound() {
                initAudioContext();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.type = 'sawtooth'; // or 'square' for a harsher sound
                oscillator.frequency.value = 150; // Low frequency
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.4);
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.4);
            }
            // --- End Web Audio API for feedback sounds ---

            // Removed TTS functions (playChineseAudio, base64ToArrayBuffer, pcmToWav, writeString)
            // Removed HanziWriter integration (loadHanziWriter)

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // Function to get shuffled Chinese word options
            function getShuffledChineseOptions(correctWord) {
                let options = [correctWord.chinese];
                // Filter out the correct word to pick incorrect options
                let tempVocab = vocabulary.filter(word => word.chinese !== correctWord.chinese);
                tempVocab = shuffleArray(tempVocab); // Shuffle temporary vocabulary

                // Add up to 3 incorrect options
                for (let i = 0; options.length < 4 && i < tempVocab.length; i++) {
                    options.push(tempVocab[i].chinese);
                }
                return shuffleArray(options); // Shuffle all options
            }

            function loadWord() {
                if (currentWordIndex >= shuffledVocabulary.length) {
                    endGame();
                    return;
                }

                const word = shuffledVocabulary[currentWordIndex];
                englishMeaningEl.textContent = word.english; // Display English meaning
                pinyinWordEl.textContent = word.pinyin.charAt(0).toLowerCase() + word.pinyin.slice(1);
                feedbackMessageEl.classList.add('hidden');
                nextWordBtn.classList.add('hidden');
                optionsContainer.innerHTML = ''; // Clear previous options

                // Removed HanziWriter loading

                const options = getShuffledChineseOptions(word); // Get Chinese options
                options.forEach((optionText) => {
                    const button = document.createElement('button');
                    button.textContent = optionText; // Display Chinese word
                    button.className = 'btn-option';
                    button.onclick = () => checkAnswer(button, optionText, word.chinese);
                    optionsContainer.appendChild(button);
                });

                updateScoreDisplay();
            }

            function checkAnswer(selectedButton, selectedOption, correctAnswer) {
                totalQuestionsAnswered++;
                const allOptionButtons = optionsContainer.querySelectorAll('.btn-option');
                allOptionButtons.forEach(btn => {
                    btn.disabled = true; // Disable all options after selection
                });

                if (selectedOption === correctAnswer) {
                    selectedButton.classList.add('correct');
                    feedbackMessageEl.textContent = '正确!';
                    feedbackMessageEl.classList.remove('text-red-600');
                    feedbackMessageEl.classList.add('text-green-600');
                    score++;
                    playCorrectSound(); // Play correct sound
                } else {
                    selectedButton.classList.add('incorrect');
                    feedbackMessageEl.textContent = `คำตอบผิด. คำตอบที่ถูกต้องคือ: ${correctAnswer} (${shuffledVocabulary[currentWordIndex].pinyin})`;
                    feedbackMessageEl.classList.remove('text-green-600');
                    feedbackMessageEl.classList.add('text-red-600');
                    // Highlight the correct answer
                    allOptionButtons.forEach(btn => {
                        if (btn.textContent === correctAnswer) { // Check for exact Chinese word match
                            btn.classList.add('correct');
                        }
                    });
                    playIncorrectSound(); // Play incorrect sound
                }
                feedbackMessageEl.classList.remove('hidden');
                nextWordBtn.classList.remove('hidden');
                updateScoreDisplay();

                // Removed HanziWriter animation call
            }

            function updateScoreDisplay() {
                scoreEl.textContent = score;
                totalCountEl.textContent = totalQuestionsAnswered;
            }

            function endGame() {
                gameArea.classList.add('hidden');
                gameOverArea.classList.remove('hidden');
                finalScoreEl.textContent = score;
                totalQuestionsEl.textContent = shuffledVocabulary.length;
            }

            function startGame() {
                shuffledVocabulary = shuffleArray([...vocabulary]); // Create a shuffled copy
                currentWordIndex = 0;
                score = 0;
                totalQuestionsAnswered = 0;
                gameArea.classList.remove('hidden');
                gameOverArea.classList.add('hidden');
                loadWord();
            }

            nextWordBtn.addEventListener('click', () => {
                currentWordIndex++;
                loadWord();
            });

            restartGameBtn.addEventListener('click', startGame);

            // Removed playAudioBtn event listener

            // --- New Vocabulary Upload Logic ---
            const uploadVocabularyBtnElement = document.getElementById('upload-vocabulary-btn');
            const vocabularyFileInputElement = document.getElementById('vocabulary-file-input');
            const uploadFeedbackMessageElElement = document.getElementById('upload-feedback-message'); 

            if (uploadVocabularyBtnElement && vocabularyFileInputElement && uploadFeedbackMessageElElement) {
                uploadVocabularyBtnElement.addEventListener('click', () => {
                    const file = vocabularyFileInputElement.files[0];
                    if (!file) {
                        uploadFeedbackMessageElElement.textContent = '请选择一个JSON文件。'; // Please select a JSON file first.
                        uploadFeedbackMessageElElement.classList.remove('text-green-600', 'hidden');
                        uploadFeedbackMessageElElement.classList.add('text-red-600');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const uploadedData = JSON.parse(e.target.result);
                            // Basic validation: Check if it's an array and elements have required properties
                            if (Array.isArray(uploadedData) && uploadedData.every(item => 
                                typeof item.chinese === 'string' && 
                                typeof item.pinyin === 'string' && 
                                typeof item.english === 'string'
                            )) {
                                vocabulary = uploadedData; // Update the global vocabulary
                                startGame(); // Restart the game with new vocabulary
                                uploadFeedbackMessageElElement.textContent = '词汇更新成功！游戏将重新开始。'; // Vocabulary updated successfully! Game will restart.
                                uploadFeedbackMessageElElement.classList.remove('text-red-600', 'hidden');
                                uploadFeedbackMessageElElement.classList.add('text-green-600');
                            } else {
                                throw new Error('JSON文件格式不正确。必须是包含 chinese, pinyin, 和 english 属性的对象的数组。'); // Invalid JSON format. Must be an array of objects with chinese, pinyin, and english.
                            }
                        } catch (error) {
                            let displayErrorMessage = `读取文件时出错: ${error.message}`; // Default error message
                            // Check if the error message indicates an XLSX file (starts with "PK")
                            if (error instanceof SyntaxError && e.target.result && e.target.result.startsWith('PK')) {
                                displayErrorMessage = '错误: 您上传的文件不是有效的JSON文件。它似乎是一个Excel (.xlsx) 文件。请在上传前将其转换为JSON。'; // Error: The file you uploaded is not a valid JSON file. It appears to be an Excel (.xlsx) file. Please convert it to JSON before uploading.
                            }
                            uploadFeedbackMessageElElement.textContent = displayErrorMessage;
                            uploadFeedbackMessageElElement.classList.remove('text-green-600', 'hidden');
                            uploadFeedbackMessageElElement.classList.add('text-red-600');
                            console.error("Error processing uploaded vocabulary file:", error);
                        }
                    };

                    reader.onerror = () => {
                        uploadFeedbackMessageElElement.textContent = '无法读取文件。'; // Could not read file.
                        uploadFeedbackMessageElElement.classList.remove('text-green-600', 'hidden');
                        uploadFeedbackMessageElElement.classList.add('text-red-600');
                    };

                    reader.readAsText(file);
                });
            } else {
                console.error("Upload buttons or file input or feedback message element not found. Hiding upload section.");
                const uploadSection = document.getElementById('upload-vocabulary-section');
                if (uploadSection) {
                    uploadSection.style.display = 'none';
                }
            }
            // --- End New Vocabulary Upload Logic ---

            startGame(); // Start the game on page load
        });
    </script>
</body>
</html>

